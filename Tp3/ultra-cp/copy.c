#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <errno.h>
#include <stdio.h>
#include <string.h>
#include <sys/sysmacros.h>
#include <dirent.h>
#include "copy.h"

#define BUFFER 4096 //Buffer size in bytes

//Recuperation of errno value
int errnum;

int FileDescrCopy(int _fdsource, int _fddestination){
	void* buffer[BUFFER];

	ssize_t rbytes;

	do
	{
		if ((rbytes = read(_fdsource,buffer,BUFFER)) == -1 ){
			errnum = errno;
			return -1;
		}

		if (write(_fddestination,buffer,rbytes) == -1)
		{
			errnum = errno;
			return -2;
		}
		

	} while (rbytes > 0);
	
	return 0;
}

int FileCopy(const char* _sourcepathname,const char* _destpathname){
	
	struct stat sourcestat;
	int sourcefd, destfd, err;

	if (lstat(_sourcepathname,&sourcestat) == -1){
		fprintf(stderr,"FileCopy lstat %s: %s\n",_sourcepathname,strerror(errno));
		return -1;
	}

	if ((sourcefd = open(_sourcepathname,O_RDONLY|O_NONBLOCK,0)) == -1){
		fprintf(stderr,"FileCopy open %s: %s\n",_sourcepathname,strerror(errno));
		return -1;
	}

	if ((destfd = open(_destpathname,O_WRONLY|O_NONBLOCK|O_CREAT|O_EXCL,sourcestat.st_mode)) == -1){
		fprintf(stderr,"FileCopy open %s: %s\n",_destpathname,strerror(errno));
		return -1;
	}

	if ((err = FileDescrCopy(sourcefd,destfd)) < 0)
	{
		switch (err)
		{
		case -1:
			fprintf(stderr,"FileDescrCopy read %s: %s\n",_sourcepathname,strerror(errnum));
			return -1;
			break;
		case -2:
			fprintf(stderr,"FileDescrCopy write %s: %s\n",_destpathname,strerror(errnum));
			return -1;
			break;
		}
	}

	return 0;
}

int FileDirCopy(const char* _sourcepathname, const char* _destpathname){
	
	char NDestPathname[100];

	strncpy(NDestPathname,_destpathname,100);
	if ((_destpathname[strnlen(_destpathname,100)-1]) != '/'){
		strncat(NDestPathname,"/",2);
	}
	strncat(NDestPathname,_sourcepathname,100);

	return FileCopy(_sourcepathname,NDestPathname);
}

int DirCopy(const char* _sourcepathname,const char* _destpathname){
	DIR* folder;
	struct dirent* file;
	struct stat dirinfo;
	struct stat fileinfo;

	if (lstat(_sourcepathname,&dirinfo) == -1){
		fprintf(stderr,"DirCopy lstat %s: %s",_sourcepathname,strerror(errno));
		return -1;
	}

	// Source is a file
	if ((dirinfo.st_mode & S_IFMT) == S_IFREG) {
		return FileDirCopy(_sourcepathname,_destpathname);
	}

	// Source is a directory
	if ((folder = opendir(_sourcepathname)) == NULL){
		fprintf(stderr,"Dircopy opendir %s: %s",_sourcepathname,strerror(errno));
		return -1;
	}

	char NDirPath[100];

	strncpy(NDirPath,_destpathname,100);
	if ((_destpathname[strnlen(_destpathname,100)-1]) != '/'){
		strncat(NDirPath,"/",2);
	}
	strncat(NDirPath,_sourcepathname,100);

	if (mkdir(NDirPath, dirinfo.st_mode) == -1){
		fprintf(stderr,"DirCopy mkdir %s: %s",_destpathname,strerror(errno));
		return -1;
	}

	while ((file = readdir(folder))){

		char NewPathname[100];
		char NDestPathname[100];

		strncpy(NewPathname,_sourcepathname,100);
		if ((_sourcepathname[strnlen(_sourcepathname,100)-1]) != '/'){
			strncat(NewPathname,"/",2);
		}
		strncat(NewPathname,file->d_name,100);

		strncpy(NDestPathname,NDirPath,100);
		if ((NDirPath[strnlen(NDirPath,100)-1]) != '/'){
			strncat(NDestPathname,"/",2);
		}
		strncat(NDestPathname,file->d_name,100);

		if (file->d_name[0] != '.' || (file->d_name[1] != '.' && file->d_name[1] != '\0')){
			if (lstat(NewPathname,&fileinfo) == -1){
				fprintf(stderr,"%s - %s\n",file->d_name,NewPathname);
				fprintf(stderr,"DirCopy lstat %s: %s",NewPathname,strerror(errno));
				return -1;
			}

			char returned = 0;

			switch (fileinfo.st_mode & S_IFMT)
			{
				case S_IFREG:	returned = FileCopy(NewPathname,NDestPathname);	break;
				case S_IFDIR:	returned = DirCopy(NewPathname,_destpathname);	break;
				default:	fprintf(stderr,"%s: Not a file or directory",NewPathname);	break;
			}

			// error handeling
			if(returned)
				return returned;
		}
	}


	if (closedir(folder) == -1){
		fprintf(stderr,"DirCopy clsedir %s: %s",_sourcepathname,strerror(errno));
		return -1;
	}

	return 0;
}