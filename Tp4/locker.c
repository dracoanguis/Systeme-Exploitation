#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <fcntl.h>
#include <string.h>
#include <errno.h>

#define INV_ARG {fprintf(stderr,"Incorrect format of arguments\n");printHelp();return -1;}

int printHelp(){
    
    printf("\tFormat: cmd type start length [whence]\n");
    printf("\tcmd: ...\n");
    printf("\ttype: ...\n");
    printf("\tstart: ...\n");
    printf("\tlength: ...\n ");
    printf("\twhence: ...\n");
    printf("\n");
    
    return 0;
}

int printLock(const int _fd, struct flock* lock){
    
    if (fcntl(_fd,F_GETLK,lock) == -1){
        fprintf(stderr,"printLock: fcntl: %s\n",strerror(errno));
        return -1;
    }
    
    return 0;
}

char* prompt(pid_t pid){

    char* res = calloc(20,sizeof(char));
    printf("%d=> ",pid);
    fflush(stdin);
    if (fgets(res,20,stdin) == NULL) {
        fprintf(stderr,"prompt: fgets error");
        exit(EXIT_FAILURE);
    }
    return res;
}

int parser(const int _fd,const char* _entry){

    char cmd = 'x';
    char type = 'x';
    int start = -1;
    int length = -1;
    char whence = 's';

    int args = 0;

    if((args = sscanf(_entry,"%c %c %d %d %c",&cmd,&type,&start,&length,&whence)) == EOF){
        fprintf(stderr,"parser: sscanf: %s\n",strerror(errno));
        printf("%c %c %d %d %c\n",cmd,type,start,length,whence);
        return -1;
    }

    if (args != 1 || args != 4 || args != 5){
        fprintf(stderr,"Incorrect format of arguments\n");
        printHelp();
        return -1;
    }

    if (cmd == '?'){
        printHelp();
        return 0;
    }

    struct flock* lock = malloc(sizeof(struct flock));

    switch (type){
        case 'r':   lock->l_type = F_RDLCK;  break;
        case 'w':   lock->l_type = F_WRLCK;  break;
        case 'u':   lock->l_type = F_UNLCK;  break;
        default:    INV_ARG; break;
    }

    if (start < 0){
        INV_ARG;
    } else {
        lock->l_start = start;
    }

    if (length < 0){
        INV_ARG;
    } else {
        lock->l_len = length;
    }

    switch (whence){
        case 's':   lock->l_whence = SEEK_SET;   break;
        case 'c':   lock->l_whence = SEEK_CUR;   break;
        case 'e':   lock->l_whence = SEEK_END;   break;
        default:    INV_ARG; break;
    }

    switch (cmd){
        case 'g':   printLock(_fd,lock);    break;
        
    }

    return 0;
}


int main(int argc, char *argv[]){

    if (argc == 1){
        fprintf(stderr,"%s: no input file precised\n",argv[0]);
        return 0;
    }

    if (argc > 2){
        printf("%s: Ther is too much arguments given, only need one\n",argv[0]);
        return 0;
    }

    int fd;
    if ((fd = open(argv[1],0) == -1 )){
        fprintf(stderr,"%s : open %s : %s\n",argv[0],argv[1],strerror(errno));
        exit(EXIT_FAILURE);
    }

    printHelp();

    while (1)
    {
        char* input = prompt(getpid());
        parser(fd,input);
        free(input);
    }

    return 0;
}