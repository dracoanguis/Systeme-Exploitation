#include <sys/types.h>
#include <sys/stat.h>
#include <time.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/sysmacros.h>
#include "read.h"

#define READ (1 << 2)
#define WRITE (1 << 1)
#define EXECUTE (1 << 0)

#define T_DIR (1 << 0)
#define T_LINK (1 << 1)
#define T_FILE (1 << 2)
#define T_UNKNOWN (1 << 3)

int ReadRights(int _num)
{
	for (int i = 2; i > -1; i--)
	{
		if ((_num >> i*3)& READ)
			printf("r");
		else
			printf("-");
		if ((_num >> i*3)& WRITE)
			printf("w");
		else
			printf("-");
		if ((_num >> i*3)& EXECUTE)
			printf("x");
		else
			printf("-");
	}

	return 0;
}


int ReadInfo(const char* _pathname){
	struct stat fileinfo;

	if (lstat(_pathname,&fileinfo) == -1){ //Opening Error
		fprintf(stderr,"ultra-cp: %s :",_pathname);
		perror("lstat");
		exit(EXIT_FAILURE);
	}

	//Type of file
	int type = T_UNKNOWN;
	switch (fileinfo.st_mode & S_IFMT)
	{
	case S_IFDIR:	printf("d");	type = T_DIR;	break;
	case S_IFREG:	printf("-");	type = T_FILE;	break;
	case S_IFLNK:	printf("l");	type = T_LINK;	break;
	default:
		printf("?");
		break;
	}

	//Rights
	ReadRights(fileinfo.st_mode);
	printf(" ");

	//Size
	printf("%8ld",fileinfo.st_size);
	printf(" ");

	//Date
	char time[50];
	strftime(time,50,"%a %b %d %T %Y",localtime(&fileinfo.st_mtim.tv_sec));
	printf("%s",time);
	printf(" ");

	//Color control
	switch (type)
	{
	case T_DIR:	printf("\033[1;33m");	break;
	case T_LINK:	printf("\033[1;35m");	break;
	case T_FILE:	printf("\033[0;34m");	break;
	default:	break;
	}

	//Access
	printf("%s",_pathname);
	printf("\n");
	printf("\033[0m");

	//Directory ?
	if ((fileinfo.st_mode & S_IFMT) == S_IFDIR)
		return 1;
	return 0;
}
