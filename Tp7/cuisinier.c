#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/types.h>
#include <semaphore.h>
#include <sys/shm.h>

#define ERROR(X) ({fprintf(stderr,"\033[0;31m");fprintf(stderr,X,argv[0],strerror(errno));fprintf(stderr,"\033[0;37m");})
#define YPRINT(...) ({printf("\033[0;33m");printf(__VA_ARGS__);printf("\033[0;37m");})

int main(int argc, char* argv[]){

    YPRINT("Start of %s\n",argv[0]);

    int shm_fd;
    char* cupboard;
    sem_t *s_start, *s_rest, *s_excup;

    //Create memory object
    if ((shm_fd = shm_open("/cupboard",O_CREAT|O_RDWR|O_EXCL,S_IRUSR|S_IWUSR|S_IRGRP|S_IWGRP)) == -1){
        ERROR("%s: shm_open: %s\n");
        return 1;
    }

    YPRINT("Created memory object\n");

    //Create semaphores
    if ((s_start = sem_open("cup_start",O_CREAT|O_EXCL|O_RDWR,S_IRUSR|S_IWUSR|S_IRGRP|S_IWGRP,0)) == SEM_FAILED){
        ERROR("%s: sem_open start: %s\n");
        return 1;
    }

    if ((s_rest = sem_open("cup_rest",O_CREAT|O_EXCL|O_RDWR,S_IRUSR|S_IWUSR|S_IRGRP|S_IWGRP,3)) == SEM_FAILED){
        ERROR("%s: sem_open rest: %s\n");
        return 1;
    }

    if ((s_excup = sem_open("cup_excup",O_CREAT|O_EXCL|O_RDWR,S_IRUSR|S_IWUSR|S_IRGRP|S_IWGRP,1)) == SEM_FAILED){
        ERROR("%s: sem_open excup: %s\n");
        return 1;
    }

    YPRINT("Created semaphores\n");

    //Set size of mem object
    if (ftruncate(shm_fd,sizeof(char)) == -1){
        ERROR("%s: ftruncate: %s\n");
        return 1;
    }

    YPRINT("Set size of object\n");

    //Start the sharing of object
    if ((cupboard = mmap(0,sizeof(char),PROT_READ|PROT_WRITE,MAP_SHARED,shm_fd,0)) == MAP_FAILED){
        ERROR("%s: mmap: %s\n");
        return 1;
    }

    YPRINT("Maped object at %p\n",cupboard);

    YPRINT("start of pizza making\n");

    int mpizzas = 0;

    while (mpizzas < 10){
        //If need to rest because there is 3 pizzas
        sem_wait(s_rest);

        //Wait random to make pizza
        sleep(rand()%3+2);

        //Permission to write in cupboard
        sem_wait(s_excup);

        (*cupboard)++;
        mpizzas++;

        printf("Curent pizza on shelf: %d\n",*cupboard);

        sem_post(s_excup);

        printf("\033[0;32mNew pizza, done: %d\n\033[0;37m",mpizzas);
    }
    
    YPRINT("Finished making pizzas\n");

    if (sem_unlink("cup_start") == -1){
        ERROR("%s: sem_unlink start: %s\n");
        return 1;
    }

    if (sem_unlink("cup_rest") == -1){
        ERROR("%s: sem_unlink rest: %s\n");
        return 1;
    }

    if (sem_unlink("cup_excup") == -1){
        ERROR("%s: sem_unlink excup: %s\n");
        return 1;
    }

    YPRINT("Unlinked semaphores\n");

    if (shm_unlink("/cupboard") == -1){
        ERROR("%s: shm_unlink: %s\n");
        return 1;
    }

    YPRINT("Unlinked shm\n");

    int servFinished;

    if (sem_getvalue(s_start,&servFinished) == -1){
        ERROR("%s: sem_getvalue: %s\n");
        return 1;
    }

    //Waiting for serveur to finish
    while (servFinished != 10)
    {
        sleep(rand()%2);

        if (sem_getvalue(s_start,&servFinished) == -1){
            ERROR("%s: sem_getvalue: %s\n");
            return 1;
        }
    }
    
    if (sem_close(s_start) == -1){
        ERROR("%s: sem_close start: %s\n");
        return 1;
    }

    if (sem_close(s_rest) == -1){
        ERROR("%s: sem_close rest: %s\n");
        return 1;
    }

    if (sem_close(s_excup) == -1){
        ERROR("%s: sem_close excup: %s\n");
        return 1;
    }

    YPRINT("Closed semaphore\n");

    if (close(shm_fd) == -1){
        ERROR("%s: close: %s\n");
        return 1;
    }

    if (munmap(cupboard,sizeof(char)) == -1){
        ERROR("%s: munmap: %s\n");
        return 1;
    }

    YPRINT("Finished cuisinier\n");

    return 0;
}