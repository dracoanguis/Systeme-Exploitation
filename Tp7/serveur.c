#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/types.h>
#include <semaphore.h>

int main(int argc, char* argv[]){

    printf("Start of %s\n",argv[0]);

    int shm_fd;
    char* cupboard;
    sem_t *s_start, *s_rest, *s_excup;

    //Open memory object
    if ((shm_fd = shm_open("/cupboard",O_RDWR,S_IRUSR|S_IWUSR|S_IRGRP|S_IWGRP)) == -1){
        fprintf(stderr,"%s: shm_open: %s\n Make sure to start serveur after cuisinier\n",argv[0],strerror(errno));
        return 1;
    }

    printf("Opened memory object\n");

    //Create semaphores
    if ((s_start = sem_open("cup_start",O_RDWR)) == SEM_FAILED){
        fprintf(stderr,"%s: sem_open start: %s\n",argv[0],strerror(errno));
        return 1;
    }

    if ((s_rest = sem_open("cup_rest",O_RDWR)) == SEM_FAILED){
        fprintf(stderr,"%s: sem_open rest: %s\n",argv[0],strerror(errno));
        return 1;
    }

    if ((s_excup = sem_open("cup_excup",O_RDWR)) == SEM_FAILED){
        fprintf(stderr,"%s: sem_open excup: %s\n",argv[0],strerror(errno));
        return 1;
    }

    printf("Opened semaphores\n");

    //Set size of mem object
    if (ftruncate(shm_fd,sizeof(char)) == -1){
        fprintf(stderr,"%s: ftruncate: %s\n",argv[0],strerror(errno));
        return 1;
    }

    printf("Set size of object\n");

    //Start the sharing of object
    if ((cupboard = mmap(0,sizeof(char),PROT_READ|PROT_WRITE,MAP_SHARED,shm_fd,0)) == MAP_FAILED){
        fprintf(stderr,"%s: mmap: %s\n",argv[0],strerror(errno));
        return 1;
    }

    printf("Mapped object at: %p\n",cupboard);
   
    char dpizzas = 0;

    sleep(rand()%2 +1);

    printf("Start of delivery\n");

    while (dpizzas <10)
    {
        sem_wait(s_excup);

        printf("Taking pizza, left: %d\n",*cupboard);

        if (*cupboard > 0){
            (*cupboard)--;
            sem_post(s_excup);
            dpizzas++;
            sem_post(s_start);
            sem_post(s_rest);
            printf("Delivered a pizza, one %d\n",dpizzas);

        } else {
            sem_post(s_excup);
            sleep(rand()%2+1);
        }
    }
    
    if (sem_close(s_start) == -1){
        fprintf(stderr,"%s: sem_close start: %s\n",argv[0],strerror(errno));
        return 1;
    }

    if (sem_close(s_rest) == -1){
        fprintf(stderr,"%s: sem_close rest: %s\n",argv[0],strerror(errno));
        return 1;
    }

    if (sem_close(s_excup) == -1){
        fprintf(stderr,"%s: sem_close excup: %s\n",argv[0],strerror(errno));
        return 1;
    }

    printf("Closed semaphore\n");

    if (close(shm_fd) == -1){
        fprintf(stderr,"%s: close: %s\n",argv[0],strerror(errno));
        return 1;
    }

    if (munmap(cupboard,sizeof(char)) == -1){
        fprintf(stderr,"%s: munmap: %s\n",argv[0],strerror(errno));
        return 1;
    }

    printf("Finished serveur\n");

    return 0;
}