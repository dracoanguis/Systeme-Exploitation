#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/types.h>
#include <semaphore.h>

#define ERROR(X) ({fprintf(stderr,"\033[0;31m");fprintf(stderr,X,argv[0],strerror(errno));fprintf(stderr,"\033[0;37m");})
#define YPRINT(...) ({printf("\033[0;33m");printf(__VA_ARGS__);printf("\033[0;37m");})

int main(int argc, char* argv[]){

    YPRINT("Start of %s\n",argv[0]);

    int shm_fd;
    char* cupboard;
    sem_t *s_start, *s_rest, *s_excup;

    //Open memory object
    if ((shm_fd = shm_open("/cupboard",O_RDWR,S_IRUSR|S_IWUSR|S_IRGRP|S_IWGRP)) == -1){
        ERROR("%s: shm_open: %s\n Make sure to start serveur after cuisinier\n");
        return 1;
    }

    YPRINT("Opened memory object\n");

    //Create semaphores
    if ((s_start = sem_open("cup_start",O_RDWR)) == SEM_FAILED){
        ERROR("%s: sem_open start: %s\n");
        return 1;
    }

    if ((s_rest = sem_open("cup_rest",O_RDWR)) == SEM_FAILED){
        ERROR("%s: sem_open rest: %s\n");
        return 1;
    }

    if ((s_excup = sem_open("cup_excup",O_RDWR)) == SEM_FAILED){
        ERROR("%s: sem_open excup: %s\n");
        return 1;
    }

    YPRINT("Opened semaphores\n");

    //Set size of mem object
    if (ftruncate(shm_fd,sizeof(char)) == -1){
        ERROR("%s: ftruncate: %s\n");
        return 1;
    }

    YPRINT("Set size of object\n");

    //Start the sharing of object
    if ((cupboard = mmap(0,sizeof(char),PROT_READ|PROT_WRITE,MAP_SHARED,shm_fd,0)) == MAP_FAILED){
        ERROR("%s: mmap: %s\n");
        return 1;
    }

    YPRINT("Mapped object at: %p\n",cupboard);
   
    char dpizzas = 0;

    sleep(rand()%2 +1);

    YPRINT("Start of delivery\n");

    while (dpizzas <10)
    {
        sem_wait(s_excup);

        printf("Taking pizza, currently on cupboard: %d\n",*cupboard);

        if (*cupboard > 0){
            (*cupboard)--;
            //Time to deliver
            sleep(rand()%4+1);
            sem_post(s_excup);

            dpizzas++;

            sem_post(s_start);
            sem_post(s_rest);
            
            printf("\033[0;32mDelivered a pizza, total delivered: %d\n\033[0;37m",dpizzas);

        } else {
            sem_post(s_excup);
            sleep(rand()%2+1);
        }
    }
    
    if (sem_close(s_start) == -1){
        ERROR("%s: sem_close start: %s\n");
        return 1;
    }

    if (sem_close(s_rest) == -1){
        ERROR("%s: sem_close rest: %s\n");
        return 1;
    }

    if (sem_close(s_excup) == -1){
        ERROR("%s: sem_close excup: %s\n");
        return 1;
    }

    YPRINT("Closed semaphore\n");

    if (close(shm_fd) == -1){
        ERROR("%s: close: %s\n");
        return 1;
    }

    if (munmap(cupboard,sizeof(char)) == -1){
        ERROR("%s: munmap: %s\n");
        return 1;
    }

    YPRINT("Finished serveur\n");

    return 0;
}