#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <errno.h>
#include <stdio.h>
#include <string.h>
#include <sys/sysmacros.h>

#define BUFFER 4096 //Buffer size in bytes

//Recuperation of errno value
int errnum;

int FileDescrCopy(int _fdsource, int _fddestination){
	void* buffer[BUFFER];

	ssize_t rbytes;

	do
	{
		if ((rbytes = read(_fdsource,buffer,BUFFER)) == -1 ){
			errnum = errno;
			return -1;
		}

		if (write(_fddestination,buffer,rbytes) == -1)
		{
			errnum = errno;
			return -2;
		}
		

	} while (rbytes > 0);
	
	return 0;
}

int FileCopy(const char* _sourcepathname,const char* _destpathname){
	
	struct stat sourcestat;
	int sourcefd, destfd, err;

	if (lstat(_sourcepathname,&sourcestat) == -1){
		fprintf(stderr,"FileCopy lstat %s: %s\n",_sourcepathname,strerror(errno));
		return -1;
	}

	if ((sourcefd = open(_sourcepathname,O_RDONLY|O_NONBLOCK,0)) == -1){
		fprintf(stderr,"FileCopy open %s: %s\n",_sourcepathname,strerror(errno));
		return -1;
	}

	if ((destfd = open(_destpathname,O_WRONLY|O_NONBLOCK|O_CREAT|O_EXCL,sourcestat.st_mode)) == -1){
		fprintf(stderr,"FileCopy open %s: %s\n",_destpathname,strerror(errno));
		return -1;
	}

	if ((err = FileDescrCopy(sourcefd,destfd)) < 0)
	{
		switch (err)
		{
		case -1:
			fprintf(stderr,"FileDescrCopy read %s: %s\n",_sourcepathname,strerror(errnum));
			return -1;
			break;
		case -2:
			fprintf(stderr,"FileDescrCopy write %s: %s\n",_destpathname,strerror(errnum));
			return -1;
			break;
		}
	}

	return 0;
}