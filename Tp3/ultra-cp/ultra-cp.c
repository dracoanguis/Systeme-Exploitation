#include <stdio.h>
#include <stdlib.h>
#include <dirent.h>
#define _GNU_SOURCE
#include <string.h>
#include <unistd.h>
#include "read.h"
#include "copy.h"

//Definition of external values of getopt defined in unistd
extern int optind, opterr, optopt;
extern char* optarg;

void ReadRecursive(const char* _pathname, char _pass){
	DIR *folder;
	struct dirent* file;

	if (_pass || ReadInfo(_pathname)){//Note in a 'or' if first valid, second never tested
		folder = opendir(_pathname);

		while ((file = readdir(folder)))
		{
			char NewPathname[100];
			strncpy(NewPathname,_pathname,100);
			if ((_pathname[strnlen(_pathname,100)-1]) != '/'){
				strncat(NewPathname,"/",2);
			}
			strncat(NewPathname,file->d_name,100);
			if (file->d_name[0] != '.' || (file->d_name[1] != '.' && file->d_name[1] != '\0')){//Bloc '.' and '..' directories
				if (ReadInfo(NewPathname)){
					ReadRecursive(NewPathname, 1);
				}
			}
		}

		closedir(folder);
	}

}

void PrintHelp(){
	printf("Usage: ultra-cp.exe [options] DATA ...\nIf there is only one DATA print a ls-like result\n");
	printf("If there is two files copy the first one in the second\nIf there is more than three DATA copy all the Datas in the last which must be a directory\nOptions:\n");
    printf("\t-f \tFrom linkls make new links\n");
    printf("\t-h \tDisplay this help and exit\n");
    printf("\t-a \tChange the rights of files even if they aren't modified\n");
    exit(EXIT_SUCCESS);
}

int main(int argc, char *argv[])
{
	int opt;
	int nopts = 0;
    char flags = 0;

	while ((opt = getopt(argc,argv,"hfa")) != -1){
		switch (opt){
		case 'h':
			PrintHelp();
			break;
		
		case 'f':
			flags = flags|FLINK;
			nopts ++;
			break;
			
		case 'a':
			flags = flags|AMODIF;
			nopts ++;
			break;

		default:
			PrintHelp();
			break;
		}
	}

	if ((argc-nopts) == 1)
		PrintHelp();
	if (argc-nopts == 2)
		ReadRecursive(argv[1+nopts],0);
	if (argc-nopts == 3){
		if (FileCopy(argv[1+nopts],argv[2+nopts],0) == -1){
			fprintf(stderr,"\t%s\n",argv[0]);
			exit(EXIT_FAILURE);
		}
	}
	if (argc-nopts > 3){
		
		for (char i = 1; i < argc-1; i++)
		{
			if (strcmp(argv[i],"-f")&&strcmp(argv[i],"-a")){
				if ( DirCopy(argv[i],argv[argc-1],0) == -1){
				fprintf(stderr,"\t%s\n",argv[0]);
				exit(EXIT_FAILURE);
				}
			}
		}
	}	
	return 0;
}
