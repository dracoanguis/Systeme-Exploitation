#include <unistd.h>
#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include <errno.h>
#include "liste.h"
#include "crypt.h"
#include "option.h"

//Macro to check validity of pointers
#define CHECK_POINTER(X) (((X) == NULL) ? ({fprintf(stderr,"Error:"__FILE__":%d: %s\n",__LINE__,strerror(errno)); exit(EXIT_FAILURE);NULL;}) : (X) )

//Digst type used when unprecised
#define BASE_DIGEST "sha1"

//Definition of external values of getopt defined in unistd
extern int optind, opterr, optopt;
extern char* optarg;

void Hachage_DFile(Liste* dfiles){
    DFile* courrant = NULL;
    while (dfiles->head != NULL)
    {
        courrant = supprimerFinElementListe(dfiles);
        Hachage_File(courrant->fichier,courrant->digest);
        DFile_End(courrant);
    }
}

int main(int argc, char *argv[])
{
    char* digest = calloc(TAILLE_DIGEST,sizeof(char));
    strncpy(digest,BASE_DIGEST,TAILLE_DIGEST);

    Liste* fichiers = CHECK_POINTER( innitialiserListe() );

    int opt;
    int args;
    while ((opt = getopt(argc, argv,"f:t:")) != -1)
    {
        switch (opt)
        {
        case 'f':
            args = (optind-1);
            while (args < argc && strcmp(argv[args],"-t"))
            {
                ajouterDebutElementListe(fichiers, CHECK_POINTER( DFile_Init(argv[args],digest) ) );
                args +=1;
            }
            break;
        
        case 't':
            strncpy(digest,optarg,TAILLE_DIGEST);
            break;

        default:
            fprintf(stderr,"There seems to be an Error somewhere.\n");
            break;
        }
    }
    
    if (fichiers->head != NULL){
        Hachage_DFile(fichiers);
    } else {
        int taille = 0;//Taille total des chaines
        args = (argc-optind);//Nombre de chaine
        for (int i = optind; i < argc; i++)
        {
            taille += strlen(argv[i]);
        }
        char* message = calloc(taille+args-1,sizeof(char));//Toujours supérieur ou égal 0 malgré ce que dit valgrind car args vaut au minimum 1 a cause de l'argument 0 qui est le nom de l'éxécutable
        for (int i = optind; i < argc; i++)
        {
            strncat(message,argv[i],strlen(argv[i]));
            if (i != argc-1){
                strncat(message," ",2);
            }
        }

        Hachage_String(message,digest);
        free(message);
    }
    

    free(digest);
    supprimerListeVide(fichiers);
    return 0;
}
