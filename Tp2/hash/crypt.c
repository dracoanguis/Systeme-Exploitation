#include <stdio.h>
#include <string.h>
#include <openssl/evp.h>
#include "crypt.h"


int Hachage_Base(const char* message,const char* digest){
    EVP_MD_CTX *mdctx;
    const EVP_MD *md;
    unsigned char md_value[EVP_MAX_MD_SIZE];
    unsigned int md_len, i;

    md = EVP_get_digestbyname(digest);
    if (md == NULL) {
        fprintf(stderr,"Error:Unknown message digest %s\n",digest);
        exit(EXIT_FAILURE);
    }

    if (message == NULL){
	    exit(EXIT_SUCCESS);
    }

    mdctx = EVP_MD_CTX_new();
    EVP_DigestInit_ex(mdctx, md,NULL);
    EVP_DigestUpdate(mdctx, message, strlen(message));
    EVP_DigestFinal_ex(mdctx, md_value, &md_len);
    EVP_MD_CTX_free(mdctx);

    printf("Digest type is %s: ",digest); /*Activer car pratique même si ca ne correspond pas à l'exemple*/
    for (i = 0; i < md_len; i++){
        printf("%02x", md_value[i]);
    }

    return EXIT_SUCCESS;
}

int Hachage_String(const char *message, const char* digest){

    if (Hachage_Base(message, digest) == EXIT_FAILURE){
        exit(EXIT_FAILURE);
    }
    printf(" '%s'",message);
    printf("\n");
    return EXIT_SUCCESS;
}

int Hachage_File(const char* _filename, const char* digest){

    FILE* file = NULL;
    file = fopen(_filename,(char*)"r");
    if (file == NULL) {
        fprintf(stderr,"Error: The '%s' file doesn't exist.\n",_filename);
        exit(EXIT_FAILURE);
    }

    int taille = 1;

    while (fgetc(file) != EOF)
    {
        taille += 1;
    }

    fseek(file,0,SEEK_SET);
    
    char* message = calloc(taille + 1,sizeof(char));

    //Probablement une mauvaise idée, mais ca fonctionne (même résultat que les fonction implanté dans bash ex:sha1sum)
    //De plus valgrind ne dis pas qu'il y a de mémoire mal utilisé
    //mais il y a peut être un problème avec des caractère non asccii
    int i = 0;
    char letter;
    letter = fgetc(file);
    while (letter != EOF)
    {
        *(message+i*(sizeof(char))) = letter;
        i++;
        letter = fgetc(file);
    }

    *(message+i*(sizeof(char))) = '\0';

    Hachage_Base(message,digest);

    printf("    %s\n",_filename);
    fclose(file);
    free(message);
    return EXIT_SUCCESS;

}
